String.prototype.panelsProcessTemplate=function(){var e=this;return e=e.replace(/{{%/g,"<%"),e=e.replace(/%}}/g,"%>"),e=e.trim()},function(e,t,i){var s={model:{},collection:{},view:{},dialog:{},fn:{}};window.panels=s,s.model.widget=Backbone.Model.extend({cell:null,defaults:{"class":null,missing:!1,values:{},raw:!1,styles:{}},initialize:function(){var e=this.get("class");"undefined"!=typeof i.widgets[e]&&i.widgets[e].installed||this.set("missing",!0)},getWidgetField:function(e){return"undefined"==typeof i.widgets[this.get("class")]?"title"===e||"description"===e?i.loc.missing_widget[e]:"":i.widgets[this.get("class")][e]},moveToCell:function(e,i){return i=t.extend({silent:!0},i),this.cell.cid===e.cid?!1:(this.cell=e,this.collection.remove(this,i),e.widgets.add(this,i),!0)},triggerEdit:function(){this.trigger("user_edit",this)},triggerDuplicate:function(){this.trigger("user_duplicate",this)},setValues:function(e){var t=!1;JSON.stringify(e)!==JSON.stringify(this.get("values"))&&(t=!0),this.set("values",e,{silent:!0}),t&&(this.trigger("change"),this.trigger("change:values"))},clone:function(e,i){"undefined"==typeof e&&(e=this.cell);var s=new this.constructor(this.attributes),l=JSON.parse(JSON.stringify(this.get("values"))),o=function(e){return t.each(e,function(i,s){"string"==typeof s&&"_"===s[0]?delete e[s]:t.isObject(e[s])&&o(e[s])}),e};return l=o(l),"SiteOrigin_Panels_Widgets_Layout"===this.get("class")&&(l.builder_id=Math.random().toString(36).substr(2)),s.set("values",l,{silent:!0}),s.set("collection",e.widgets,{silent:!0}),s.cell=e,s.isDuplicate=!0,s},getTitle:function(){var s=i.widgets[this.get("class")];if("undefined"==typeof s)return this.get("class").replace(/_/g," ");if("undefined"!=typeof s.panels_title&&s.panels_title===!1)return i.widgets[this.get("class")].description;var l=this.get("values"),o=["title","text"];for(var n in l)l.hasOwnProperty(n)&&o.push(n);o=t.uniq(o);for(var a in o)if("undefined"!=typeof l[o[a]]&&"string"==typeof l[o[a]]&&""!==l[o[a]]&&!e.isNumeric(l[o[a]])){var r=l[o[a]];r=r.replace(/<\/?[^>]+(>|$)/g,"");var d=r.split(" ");return d=d.slice(0,20),d.join(" ")}return this.getWidgetField("description")}}),s.view.widget=Backbone.View.extend({template:t.template(e("#siteorigin-panels-builder-widget").html().panelsProcessTemplate()),cell:null,dialog:null,events:{"click .widget-edit":"editHandler","click .title h4":"editHandler","click .actions .widget-duplicate":"duplicateHandler","click .actions .widget-delete":"deleteHandler"},initialize:function(){this.model.on("user_edit",this.editHandler,this),this.model.on("user_duplicate",this.duplicateHandler,this),this.model.on("destroy",this.onModelDestroy,this),this.model.on("visual_destroy",this.visualDestroyModel,this),this.model.on("change:values",this.onModelChange,this)},render:function(e){if(e=t.extend({loadForm:!1},e),this.setElement(this.template({title:this.model.getWidgetField("title"),description:this.model.getTitle()})),this.$el.data("view",this),0===t.size(this.model.get("values"))||e.loadForm){var i=this.getEditDialog();i.once("form_loaded",i.saveWidget,i),i.setupDialog()}},visualCreate:function(){this.$el.hide().fadeIn("fast")},getEditDialog:function(){return null===this.dialog&&(this.dialog=new s.dialog.widget({model:this.model}),this.dialog.setBuilder(this.cell.row.builder),this.dialog.widgetView=this),this.dialog},editHandler:function(){return this.getEditDialog().openDialog(),!1},duplicateHandler:function(){this.cell.row.builder.addHistoryEntry("widget_duplicated");var e=this.model.clone(this.model.cell);return this.cell.model.widgets.add(e,{at:this.model.collection.indexOf(this.model)+1}),!1},deleteHandler:function(){return this.model.trigger("visual_destroy"),!1},onModelChange:function(){this.$(".description").html(this.model.getTitle())},onModelDestroy:function(){this.remove()},visualDestroyModel:function(){this.cell.row.builder.addHistoryEntry("widget_deleted");var e=this;this.$el.fadeOut("fast",function(){e.cell.row.resize(),e.model.destroy()})},buildContextualMenu:function(e,t){var l=this;t.addSection({sectionTitle:i.loc.contextual.add_widget_below,searchPlaceholder:i.loc.contextual.search_widgets,defaultDisplay:i.contextual.default_widgets},i.widgets,function(e){l.cell.row.builder.addHistoryEntry("widget_added");var t=new s.model.widget({"class":e});t.cell=l.cell.model,l.cell.model.widgets.add(t,{at:l.model.collection.indexOf(l.model)+1})}),this.cell.row.buildContextualMenu(e,t)}}),s.collection.widgets=Backbone.Collection.extend({model:s.model.widget,initialize:function(){}}),s.model.cell=Backbone.Model.extend({widgets:{},row:null,defaults:{weight:0},initialize:function(){this.widgets=new s.collection.widgets,this.on("destroy",this.onDestroy,this)},onDestroy:function(){t.invoke(this.widgets.toArray(),"destroy"),this.widgets.reset()},clone:function(e,i){"undefined"==typeof e&&(e=this.row),i=t.extend({cloneWidgets:!0},i);var s=new this.constructor(this.attributes);return s.set("collection",e.cells,{silent:!0}),s.row=e,i.cloneWidgets&&this.widgets.each(function(e){s.widgets.add(e.clone(s,i),{silent:!0})}),s}}),s.collection.cells=Backbone.Collection.extend({model:s.cell,initialize:function(){this.on("add",this.onAddCell,this)},totalWeight:function(){var e=0;return this.each(function(t){e+=t.get("weight")}),e}}),s.view.cell=Backbone.View.extend({template:t.template(e("#siteorigin-panels-builder-cell").html().panelsProcessTemplate()),events:{"click .cell-wrapper":"handleCellClick","click .so-cell-actions a":"handleActionClick"},row:null,widgetSortable:null,initialize:function(){this.model.widgets.on("add",this.onAddWidget,this)},render:function(){var e={weight:this.model.get("weight"),totalWeight:this.row.model.cells.totalWeight()};this.setElement(this.template(e)),this.$el.data("view",this);var t=this;this.model.widgets.each(function(e){var i=new s.view.widget({model:e});i.cell=t,i.render(),i.$el.appendTo(t.$(".widgets-container"))}),this.initSortable(),this.initResizable()},initSortable:function(){var t=this,i=t.row.builder.$el.attr("id");this.widgetSortable=this.$el.find(".widgets-container").sortable({placeholder:"so-widget-sortable-highlight",connectWith:"#"+i+" .so-cells .cell .widgets-container",tolerance:"pointer",scroll:!1,over:function(e,i){t.row.builder.trigger("widget_sortable_move")},stop:function(i,s){t.row.builder.addHistoryEntry("widget_moved");var l=e(s.item).data("view"),o=e(s.item).closest(".cell").data("view");l.model.moveToCell(o.model),l.cell=o,t.row.builder.sortCollections()},helper:function(e,t){var i=t.clone().css({width:t.outerWidth(),"z-index":1e4,position:"fixed"}).addClass("widget-being-dragged").appendTo("body");return t.outerWidth()>720&&i.animate({"margin-left":e.pageX-t.offset().left-240,width:480},"fast"),i}})},refreshSortable:function(){this.widgetSortable.sortable("refresh")},initResizable:function(){var t,i=this.$(".resize-handle").css("position","absolute"),s=this.row.$el,l=this;i.draggable({axis:"x",containment:s,start:function(i,s){if(t=l.$el.prev().data("view"),"undefined"==typeof t)return!1;var o=l.$el.clone().appendTo(s.helper).css({position:"absolute",top:"0",width:l.$el.outerWidth(),left:5,height:l.$el.outerHeight()});o.find(".resize-handle").remove();var n=t.$el.clone().appendTo(s.helper).css({position:"absolute",top:"0",width:t.$el.outerWidth(),right:5,height:t.$el.outerHeight()});n.find(".resize-handle").remove(),e(this).data({newCellClone:o,prevCellClone:n})},drag:function(s,o){var n=l.row.$el.width()+10,a=l.model.get("weight")-(o.position.left+i.outerWidth()/2)/n,r=t.model.get("weight")+(o.position.left+i.outerWidth()/2)/n;e(this).data("newCellClone").css("width",n*a).find(".preview-cell-weight").html(Math.round(1e3*a)/10),e(this).data("prevCellClone").css("width",n*r).find(".preview-cell-weight").html(Math.round(1e3*r)/10)},stop:function(s,o){e(this).data("newCellClone").remove(),e(this).data("prevCellClone").remove();var n=l.row.$el.width()+10,a=l.model.get("weight")-(o.position.left+i.outerWidth()/2)/n,r=t.model.get("weight")+(o.position.left+i.outerWidth()/2)/n;a>.02&&r>.02&&(l.row.builder.addHistoryEntry("cell_resized"),l.model.set("weight",a),t.model.set("weight",r),l.row.resize()),o.helper.css("left",-i.outerWidth()/2)}})},onAddWidget:function(e,i,l){l=t.extend({noAnimate:!1},l);var o=new s.view.widget({model:e});o.cell=this,"undefined"==typeof e.isDuplicate&&(e.isDuplicate=!1),o.render({loadForm:e.isDuplicate}),"undefined"==typeof l.at||i.length<=1?o.$el.appendTo(this.$(".widgets-container")):o.$el.insertAfter(this.$(".widgets-container .so-widget").eq(l.at-1)),l.noAnimate===!1&&o.visualCreate(),this.refreshSortable(),this.row.resize()},handleActionClick:function(e){return!1},buildContextualMenu:function(e,t){var l=this;t.addSection({sectionTitle:i.loc.contextual.add_widget_cell,searchPlaceholder:i.loc.contextual.search_widgets,defaultDisplay:i.contextual.default_widgets},i.widgets,function(e){l.row.builder.addHistoryEntry("widget_added");var t=new s.model.widget({"class":e});t.cell=l.model,t.cell.widgets.add(t)}),this.row.buildContextualMenu(e,t)}}),s.model.row=Backbone.Model.extend({cells:{},builder:null,defaults:{style:{}},initialize:function(){this.cells=new s.collection.cells,this.on("destroy",this.onDestroy,this)},setCells:function(e){var i=this;if(0===this.cells.length)t.each(e,function(e){var t=new s.model.cell({weight:e,collection:i.cells});t.row=i,i.cells.add(t)});else{if(e.length>this.cells.length)for(var l=this.cells.length;l<e.length;l++){var o=new s.model.cell({weight:e[e.length+l],collection:i.cells});o.row=this,i.cells.add(o)}else if(e.length<this.cells.length){var n=this.cells.at(e.length-1);t.each(this.cells.slice(e.length,this.cells.length),function(e){for(var t=e.widgets.models.slice(0),i=0;i<t.length;i++)t[i].moveToCell(n,{silent:!1});e.destroy()})}this.cells.each(function(t,i){t.set("weight",e[i])})}this.reweightCells()},reweightCells:function(){var e=0;this.cells.each(function(t){e+=t.get("weight")}),this.cells.each(function(t){t.set("weight",t.get("weight")/e)}),this.trigger("reweight_cells")},onDestroy:function(){t.invoke(this.cells.toArray(),"destroy"),this.cells.reset()},clone:function(e,i){"undefined"==typeof e&&(e=this.builder),i=t.extend({cloneCells:!0},i);var s=new this.constructor(this.attributes);return s.set("collection",e.rows,{silent:!0}),s.builder=e,i.cloneCells&&this.cells.each(function(e){s.cells.add(e.clone(s,i),{silent:!0})}),s}}),s.collection.rows=Backbone.Collection.extend({model:s.model.row,empty:function(){for(var e;;){if(e=this.collection.first(),!e)break;e.destroy()}}}),s.view.row=Backbone.View.extend({template:t.template(e("#siteorigin-panels-builder-row").html().panelsProcessTemplate()),events:{"click .so-row-settings":"editSettingsHandler","click .so-row-duplicate":"duplicateHandler","click .so-row-delete":"confirmedDeleteHandler"},builder:null,dialog:null,initialize:function(){this.model.cells.on("add",this.handleCellAdd,this),this.model.cells.on("remove",this.handleCellRemove,this),this.model.on("reweight_cells",this.resize,this),this.model.on("destroy",this.onModelDestroy,this),this.model.on("visual_destroy",this.visualDestroyModel,this);var e=this;this.model.cells.each(function(t){e.listenTo(t.widgets,"add",e.resize)}),this.model.cells.on("add",function(t){e.listenTo(t.widgets,"add",e.resize)},this)},render:function(){this.setElement(this.template()),this.$el.data("view",this);var e=this;return this.model.cells.each(function(t){var i=new s.view.cell({model:t});i.row=e,i.render(),i.$el.appendTo(e.$(".so-cells"))}),this.builder.on("widget_sortable_move",this.resize,this),this.builder.on("builder_resize",this.resize,this),this.resize(),this},visualCreate:function(){this.$el.hide().fadeIn("fast")},resize:function(t){if(!this.$el.is(":visible"))return!1;this.$el.find(".so-cells .cell-wrapper").css("min-height",0);var i=0;this.$el.find(".so-cells .cell").each(function(){i=Math.max(i,e(this).height()),e(this).css("width",100*e(this).data("view").model.get("weight")+"%")}),this.$el.find(".so-cells .cell-wrapper").css("min-height",Math.max(i,70))},onModelDestroy:function(){this.remove()},visualDestroyModel:function(){this.builder.addHistoryEntry("row_deleted");var e=this;this.$el.fadeOut("normal",function(){e.model.destroy(),e.builder.model.refreshPanelsData(),e.builder.liveEditor.displayed&&e.builder.liveEditor.refreshWidgets()})},duplicateHandler:function(){this.builder.addHistoryEntry("row_duplicated");var e=this.model.clone(this.builder.model);return this.builder.model.rows.add(e,{at:this.builder.model.rows.indexOf(this.model)+1}),!1},confirmedDeleteHandler:function(t){var s=e(t.target);if(s.hasClass("dashicons")&&(s=s.parent()),s.hasClass("so-confirmed"))this.visualDestroyModel();else{var l=s.html();s.addClass("so-confirmed").html('<span class="dashicons dashicons-yes"></span>'+i.loc.dropdown_confirm),setTimeout(function(){s.removeClass("so-confirmed").html(l)},2500)}return!1},editSettingsHandler:function(){return null===this.dialog&&(this.dialog=new s.dialog.row,this.dialog.setBuilder(this.builder).setRowModel(this.model)),this.dialog.openDialog(),!1},deleteHandler:function(){return this.model.destroy(),!1},handleCellAdd:function(e){var t=new s.view.cell({model:e});t.row=this,t.render(),t.$el.appendTo(this.$(".so-cells"))},handleCellRemove:function(t){this.$el.find(".so-cells > .cell").each(function(){var i=e(this).data("view");return"undefined"==typeof i?!1:void(i.model.cid===t.cid&&i.remove())})},buildContextualMenu:function(e,t){for(var l=this,o=[],n=1;5>n;n++)o.push({title:n+" "+i.loc.contextual.column});t.addSection({sectionTitle:i.loc.contextual.add_row,search:!1},o,function(e){l.builder.addHistoryEntry("row_added");for(var t=Number(e)+1,i=[],o=0;t>o;o++)i.push(100/t);var n=new s.model.row({collection:l.collection});n.setCells(i),n.builder=l.builder,l.builder.model.rows.add(n,{at:l.builder.model.rows.indexOf(l.model)+1})})}}),s.model.builder=Backbone.Model.extend({rows:{},defaults:{data:{widgets:[],grids:[],grid_cells:[]}},initialize:function(){this.rows=new s.collection.rows},addRow:function(e,i){i=t.extend({noAnimate:!1},i);var l=new s.model.row({collection:this.rows});return l.setCells(e),l.builder=this,this.rows.add(l,i),l},loadPanelsData:function(e){this.emptyRows(),this.set("data",e,{silent:!0});var i=[];if("undefined"==typeof e.grid_cells)return void this.trigger("load_panels_data");for(var l,o=0;o<e.grid_cells.length;o++)l=parseInt(e.grid_cells[o].grid),"undefined"==typeof i[l]&&(i[l]=[]),i[l].push(parseFloat(e.grid_cells[o].weight));var n=this;t.each(i,function(t,i){var s=n.addRow(t,{noAnimate:!0});"undefined"!=typeof e.grids[i].style&&s.set("style",e.grids[i].style)}),"undefined"!=typeof e.widgets&&(t.each(e.widgets,function(e){try{var t=null;"undefined"!=typeof e.panels_info?(t=e.panels_info,delete e.panels_info):(t=e.info,delete e.info);var i=n.rows.at(parseInt(t.grid)),l=i.cells.at(parseInt(t.cell)),o=new s.model.widget({"class":t["class"],values:e});"undefined"!=typeof t.style&&o.set("style",t.style),o.cell=l,l.widgets.add(o,{noAnimate:!0})}catch(a){}}),this.trigger("load_panels_data"))},getPanelsData:function(){var e={widgets:[],grids:[],grid_cells:[]},i=0;return this.rows.each(function(s,l){s.cells.each(function(s,o){s.widgets.each(function(s,n){var a=t.extend(t.clone(s.get("values")),{panels_info:{"class":s.get("class"),raw:s.get("raw"),grid:l,cell:o,id:i++,style:s.get("style")}});e.widgets.push(a)}),e.grid_cells.push({grid:l,weight:s.get("weight")})}),e.grids.push({cells:s.cells.length,style:s.get("style")})}),e},refreshPanelsData:function(){var e=JSON.stringify(this.get("data")),t=this.getPanelsData();this.set("data",t,{silent:!0}),JSON.stringify(t)!==e&&(this.trigger("change"),this.trigger("change:data"))},emptyRows:function(){return t.invoke(this.rows.toArray(),"destroy"),this.rows.reset(),this}}),s.view.builder=Backbone.View.extend({template:t.template(e("#siteorigin-panels-builder").html().panelsProcessTemplate()),dialogs:{},rowsSortable:null,dataField:!1,currentData:"",attachedToEditor:!1,liveEditor:!1,menu:!1,builderType:"",events:{"click .so-tool-button.so-widget-add":"displayAddWidgetDialog","click .so-tool-button.so-row-add":"displayAddRowDialog","click .so-tool-button.so-prebuilt-add":"displayAddPrebuiltDialog","click .so-tool-button.so-history":"displayHistoryDialog","click .so-tool-button.so-live-editor":"displayLiveEditor","click .so-cells .cell .cell-wrapper":"cellClickHandler"},rows:null,initialize:function(){var i=this;return this.dialogs={widgets:new s.dialog.widgets,row:new s.dialog.row,prebuilt:new s.dialog.prebuilt},t.each(this.dialogs,function(e,t,s){s[t].setBuilder(i)}),this.dialogs.row.setRowDialogType("create"),this.model.rows.on("add",this.onAddRow,this),e(window).resize(function(e){e.target===window&&i.trigger("builder_resize")}),this.model.on("change:data",this.storeModelData,this),this.on("content_change",this.handleContentChange,this),this.on("display_builder",this.handleDisplayBuilder,this),this.model.on("change:data load_panels_data",this.toggleWelcomeDisplay,this),this.menu=new s.utils.menu({}),this.menu.on("activate_context",this.activateContextMenu,this),this},render:function(){return this.$el.html(this.template()),this.$el.attr("id","siteorigin-panels-builder-"+this.cid).addClass("so-builder-container"),this.trigger("builder_rendered"),this},attach:function(e){return e=t.extend({type:"",container:!1,dialog:!1},e),e.dialog?(this.dialog=new s.dialog.builder,this.dialog.builder=this):(this.$el.appendTo(e.container),this.metabox=e.container.closest(".postbox"),this.initSortable(),this.trigger("attached_to_container",e.container)),this.builderType=e.type,this},attachToEditor:function(){if("undefined"==typeof this.metabox)return this;this.attachedToEditor=!0;var s=this.metabox,l=this;e("#wp-content-wrap .wp-editor-tabs").find(".wp-switch-editor").click(function(t){t.preventDefault(),e("#wp-content-editor-container, #post-status-info").show(),s.hide(),e("#wp-content-wrap").removeClass("panels-active"),e("#content-resize-handle").show(),l.trigger("hide_builder")}).end().append(e('<a id="content-panels" class="hide-if-no-js wp-switch-editor switch-panels">'+s.find("h3.hndle span").html()+"</a>").click(function(t){t.preventDefault();e(this);e("#wp-content-wrap, #post-status-info").hide(),s.show().find("> .inside").show(),e(window).resize(),e(document).scroll(),l.trigger("display_builder")})),s.find(".so-switch-to-standard").click(function(t){t.preventDefault(),confirm(i.loc.confirm_stop_builder)&&(l.addHistoryEntry("back_to_editor"),l.model.loadPanelsData(!1)),e("#wp-content-wrap, #post-status-info").show(),s.hide(),e(window).resize()}).show(),s.insertAfter("#wp-content-wrap").hide().addClass("attached-to-editor");var o=this.model.get("data");("undefined"!=typeof o.widgets&&0!==t.size(o.widgets)||"undefined"!=typeof o.grids&&0!==t.size(o.grids))&&e("#content-panels.switch-panels").click();var n=function(){var t=l.$(".so-builder-toolbar"),i=e(window).scrollTop()-l.$el.offset().top;"fixed"===e("#wpadminbar").css("position")&&(i+=e("#wpadminbar").outerHeight());var s={top:0,bottom:l.$el.outerHeight()-t.outerHeight()+20};i>s.top&&i<s.bottom?"fixed"!==t.css("position")&&t.css({top:e("#wpadminbar").outerHeight(),left:l.$el.offset().left,width:l.$el.outerWidth(),position:"fixed"}):t.css({top:Math.min(Math.max(i,0),l.$el.outerHeight()-t.outerHeight()+20),left:0,width:"100%",position:"absolute"}),l.$el.css("padding-top",t.outerHeight())};return e(window).resize(n),e(document).scroll(n),n(),this},initSortable:function(){var e=(this.$el,this);this.rowsSortable=this.$el.find(".so-rows-container").sortable({appendTo:"#wpwrap",items:".so-row-container",handle:".so-row-move",axis:"y",tolerance:"pointer",scroll:!1,stop:function(t){e.addHistoryEntry("row_moved"),e.sortCollections()}})},refreshSortable:function(){null!==this.rowsSortable&&this.rowsSortable.sortable("refresh")},setDataField:function(e,i){if(i=t.extend({load:!0},i),this.dataField=e,this.dataField.data("builder",this),i.load&&""!==e.val()){var s;try{s=JSON.parse(this.dataField.val())}catch(l){s=""}this.model.loadPanelsData(s),this.currentData=s,this.toggleWelcomeDisplay()}return this},storeModelData:function(){var t=JSON.stringify(this.model.get("data"));e(this.dataField).val()!==t&&(e(this.dataField).val(t),e(this.dataField).trigger("change"),this.trigger("content_change"))},onAddRow:function(e,i,l){l=t.extend({noAnimate:!1},l);var o=new s.view.row({model:e});o.builder=this,o.render(),"undefined"==typeof l.at||i.length<=1?o.$el.appendTo(this.$(".so-rows-container")):o.$el.insertAfter(this.$(".so-rows-container .so-row-container").eq(l.at-1)),l.noAnimate===!1&&o.visualCreate(),this.refreshSortable(),o.resize()},displayAddWidgetDialog:function(){return this.dialogs.widgets.openDialog(),!1},displayAddRowDialog:function(){return this.dialogs.row.openDialog(),this.dialogs.row.setRowModel(),!1},displayAddPrebuiltDialog:function(){return this.dialogs.prebuilt.openDialog(),!1},displayHistoryDialog:function(){return this.dialogs.history.openDialog(),!1},cellClickHandler:function(t){this.$el.find(".so-cells .cell").removeClass("cell-selected");e(t.target).parent().addClass("cell-selected")},getActiveCell:function(e){if(e=t.extend({createCell:!0,defaultPosition:"first"},e),0===this.$(".so-cells .cell").length){if(!e.createCell)return null;this.model.addRow([1],{noAnimate:!0})}var i=this.$(".so-cells .cell.cell-selected");return i.length||(i="last"===e.defaultPosition?this.$(".so-cells .cell").first():this.$(".so-cells .cell").last()),i.data("view").model},sortCollections:function(){var t={};this.$(".so-rows-container .so-row-container").each(function(i,s){var l=e(s);t[l.data("view").model.cid]=i,l.find(".so-cells .cell").each(function(i,s){var l=e(s);l.find(".so-widget").each(function(i,s){var l=e(s);t[l.data("view").model.cid]=i})})}),this.model.rows.models=this.model.rows.sortBy(function(e){return t[e.cid]}),this.model.rows.each(function(e){e.cells.each(function(e){e.widgets.models=e.widgets.sortBy(function(e){return t[e.cid]})})}),this.model.refreshPanelsData()},addLiveEditor:function(e){return"undefined"==typeof s.view.liveEditor?this:(this.liveEditor=new s.view.liveEditor,this.liveEditor.setPostId(e),this.liveEditor.builder=this,this.liveEditor.hasPreviewUrl()&&this.$(".so-builder-toolbar .so-live-editor").show(),this)},displayLiveEditor:function(){return"undefined"==typeof this.liveEditor?!1:(this.liveEditor.open(),!1)},addHistoryBrowser:function(){return"undefined"==typeof s.dialog.history?this:(this.dialogs.history=new s.dialog.history,this.dialogs.history.builder=this,this.dialogs.history.entries.builder=this.model,this.dialogs.history.setRevertEntry(this.model),void this.$(".so-builder-toolbar .so-history").show())},addHistoryEntry:function(e,t){"undefined"==typeof t&&(t=null),"undefined"!=typeof this.dialogs.history&&this.dialogs.history.entries.addEntry(e,t)},handleContentChange:function(){this.attachedToEditor&&this.$el.is(":visible")&&this.model.rows.length>0&&e.post(i.ajaxurl,{action:"so_panels_builder_content",panels_data:JSON.stringify(this.model.getPanelsData()),post_id:e("#post_ID").val()},function(t){if(""!==t){var i=e("<div />").html(t);i.find("div").each(function(){var t=e(this).contents();e(this).replaceWith(t)}),t=i.html(),"undefined"==typeof tinyMCE||null===tinyMCE.get("content")?e("#content").val(t):tinyMCE.get("content").setContent(t),e("#content").focusout()}}),this.liveEditor!==!1&&this.liveEditor.refreshPreview()},handleDisplayBuilder:function(){var s,l="";if("undefined"!=typeof tinyMCE&&(s=tinyMCE.get("content")),l=s&&"function"==typeof s.getContent?s.getContent():e("textarea#content").val(),t.isEmpty(this.model.get("data"))&&""!==l){if(!confirm(i.loc.confirm_use_builder))return;var o="";if("undefined"!=typeof i.widgets.SiteOrigin_Widget_Editor_Widget?o="SiteOrigin_Widget_Editor_Widget":"undefined"!=typeof i.widgets.WP_Widget_Text&&(o="WP_Widget_Text"),""===o)return;this.model.loadPanelsData({grid_cells:[{grid:0,weight:1}],grids:[{cells:1}],widgets:[{filter:"1",text:l,title:"",type:"visual",panels_info:{"class":o,raw:!1,grid:0,cell:0}}]}),this.model.trigger("change"),this.model.trigger("change:data")}},setDialogParents:function(e,i){t.each(this.dialogs,function(t,s,l){l[s].setParent(e,i)}),this.on("add_dialog",function(t){t.setParent(e,i)},this)},toggleWelcomeDisplay:function(){this.model.rows.length?this.$(".so-panels-welcome-message").hide():this.$(".so-panels-welcome-message").show()},activateContextMenu:function(t,i){var s=this;if("undefined"==typeof window.panelsDialogOpen||!window.panelsDialogOpen){var l=e([]).add(s.$(".so-rows-container > .so-row-container")).add(s.$(".so-cells > .cell")).add(s.$(".cell-wrapper > .so-widget")).filter(function(s){return i.isOverEl(e(this),t)}),o=l.last().data("view");void 0!==o&&void 0!==o.buildContextualMenu&&o.buildContextualMenu(t,i)}}}),s.view.dialog=Backbone.View.extend({dialogTemplate:t.template(e("#siteorigin-panels-dialog").html().panelsProcessTemplate()),dialogTabTemplate:t.template(e("#siteorigin-panels-dialog-tab").html().panelsProcessTemplate()),tabbed:!1,rendered:!1,builder:!1,className:"so-panels-dialog-wrapper",dialogClass:"",parentDialog:!1,dialogOpen:!1,events:{"click .so-close":"closeDialog","click .so-nav.so-previous":"navToPrevious","click .so-nav.so-next":"navToNext"},initialize:function(){this.once("open_dialog",this.render),this.once("open_dialog",this.attach),this.once("open_dialog",this.setDialogClass),this.trigger("initialize_dialog",this),"undefined"!=typeof this.initializeDialog&&this.initializeDialog()},getNextDialog:function(){return null},getPrevDialog:function(){return null},setDialogClass:function(){""!==this.dialogClass&&this.$(".so-panels-dialog").addClass(this.dialogClass)},setBuilder:function(e){return this.builder=e,e.trigger("add_dialog",this,this.builder),this},attach:function(){return this.$el.appendTo("body"),this},parseDialogContent:function(i,s){s=t.extend({cid:this.cid},s);var l=e(t.template(i.panelsProcessTemplate())(s)),o={title:l.find(".title").html(),buttons:l.find(".buttons").html(),content:l.find(".content").html()};return l.has(".left-sidebar")&&(o.left_sidebar=l.find(".left-sidebar").html()),l.has(".right-sidebar")&&(o.right_sidebar=l.find(".right-sidebar").html()),o},renderDialog:function(t){if(this.$el.html(this.dialogTemplate(t)).hide(),this.$el.data("view",this),this.$el.addClass("so-panels-dialog-wrapper"),this.parentDialog!==!1){var i=this,s=e('<h3 class="so-parent-link"></h3>').html(this.parentDialog.text+'<div class="so-separator"></div>');s.click(function(e){e.preventDefault(),i.closeDialog(),i.parentDialog.openDialog()}),this.$(".so-title-bar").prepend(s)}return this},initTabs:function(){var t=this.$el.find(".so-sidebar-tabs li a");if(0===t.length)return this;var i=this;return t.click(function(t){t.preventDefault();var s=e(this);i.$(".so-sidebar-tabs li").removeClass("tab-active"),i.$(".so-content .so-content-tabs > *").hide(),s.parent().addClass("tab-active");var l=s.attr("href");if("undefined"!=typeof l&&"#"===l.charAt(0)){var o=l.split("#")[1];i.$(".so-content .so-content-tabs .tab-"+o).show()}i.trigger("tab_click",s)}),this.$el.find(".so-sidebar-tabs li a").first().click(),this},setupDialog:function(){this.openDialog(),this.closeDialog()},refreshDialogNav:function(){this.$(".so-title-bar .so-nav").show().removeClass("so-disabled");var e=this.getNextDialog(),t=this.$(".so-title-bar .so-next"),i=this.getPrevDialog(),s=this.$(".so-title-bar .so-previous");null===e?t.hide():e===!1&&t.addClass("so-disabled"),null===i?s.hide():i===!1&&s.addClass("so-disabled")},openDialog:function(){this.trigger("open_dialog"),this.dialogOpen=!0,window.panelsDialogOpen=!0,this.refreshDialogNav(),this.bodyScrollTop=e("body").scrollTop(),e("body").css({overflow:"hidden"}),e(window).on("keyup",this.keyboardListen),this.$el.show(),this.trigger("open_dialog_complete")},closeDialog:function(t){return this.trigger("close_dialog"),this.dialogOpen=!1,window.panelsDialogOpen=!1,"undefined"!=typeof this.builder&&this.builder.model.refreshPanelsData(),this.$el.hide(),e(".so-panels-dialog-wrapper").is(":visible")||(e("body").css({overflow:"auto"}),e("body").scrollTop(this.bodyScrollTop)),e(window).off("keyup",this.keyboardListen),this.trigger("close_dialog_complete"),!1},keyboardListen:function(t){27===t.which&&e(".so-panels-dialog-wrapper .so-close").trigger("click")},navToPrevious:function(){this.closeDialog(null);var e=this.getPrevDialog();null!==e&&e!==!1&&e.openDialog()},navToNext:function(){this.closeDialog(null);var e=this.getNextDialog();null!==e&&e!==!1&&e.openDialog()},getFormValues:function(i){"undefined"==typeof i&&(i=".so-content");var s,l=this.$(i),o={};return l.find("[name]").each(function(){var i=e(this),l=/([A-Za-z_]+)\[(.*)\]/.exec(i.attr("name"));"undefined"==typeof l[2]?s=i.attr("name"):(s=l[2].split("]["),s.unshift(l[1])),s=s.map(function(e){return!isNaN(parseFloat(e))&&isFinite(e)?parseInt(e):e});var n=o,a=null,r="string"==typeof i.attr("type")?i.attr("type").toLowerCase():!1;if("checkbox"===r)a=i.is(":checked")?""!==i.val()?i.val():!0:null;else if("radio"===r){if(!i.is(":checked"))return;a=i.val()}else if("TEXTAREA"===i.prop("tagName")&&i.hasClass("wp-editor-area")){var d=null;"undefined"!=typeof tinyMCE&&(d=tinyMCE.get(i.attr("id"))),a=null===d||"function"!=typeof d.getContent||d.isHidden()?i.val():d.getContent()}else if("SELECT"===i.prop("tagName")){var c=i.find("option:selected");1===c.length?a=i.find("option:selected").val():c.length>1&&(a=t.map(i.find("option:selected"),function(t,i){return e(t).val()}))}else a=i.val();if("undefined"!=typeof i.data("panels-filter"))switch(i.data("panels-filter")){case"json_parse":try{a=JSON.parse(a)}catch(h){a=""}}if(null!==a)for(var u=0;u<s.length;u++)u===s.length-1?""===s[u]?n.push(a):n[s[u]]=a:("undefined"==typeof n[s[u]]&&(n[s[u]]=""===s[u+1]?[]:{}),n=n[s[u]])}),console.log(o),o},setStatusMessage:function(e,t){this.$(".so-toolbar .so-status").html(e),"undefined"!=typeof t&&t&&this.$(".so-toolbar .so-status").addClass("so-panels-loading")},setParent:function(e,t){this.parentDialog={text:e,dialog:t}}}),s.dialog.builder=s.view.dialog.extend({dialogClass:"so-panels-dialog-add-builder",render:function(){this.renderDialog(this.parseDialogContent(e("#siteorigin-panels-dialog-builder").html(),{})),this.$(".so-content .siteorigin-panels-builder").append(this.builder.$el)},initializeDialog:function(){var e=this;this.once("open_dialog_complete",function(){e.builder.initSortable()}),this.on("open_dialog_complete",function(){e.builder.trigger("builder_resize")})}}),s.dialog.widgets=s.view.dialog.extend({builder:null,widgetTemplate:t.template(e("#siteorigin-panels-dialog-widgets-widget").html().panelsProcessTemplate()),filter:{},dialogClass:"so-panels-dialog-add-widget",events:{"click .so-close":"closeDialog","click .widget-type":"widgetClickHandler","keyup .so-sidebar-search":"searchHandler"},initializeDialog:function(){this.on("open_dialog",function(){this.filter.search="",this.filterWidgets(this.filter)},this),this.on("open_dialog_complete",function(){this.$(".so-sidebar-search").val("").focus(),this.balanceWidgetHeights()}),this.on("tab_click",this.tabClickHandler,this)},render:function(){this.renderDialog(this.parseDialogContent(e("#siteorigin-panels-dialog-widgets").html(),{})),t.each(i.widgets,function(t){var i=e(this.widgetTemplate({title:t.title,description:t.description}));"undefined"==typeof t.icon&&(t.icon="dashicons dashicons-admin-generic"),"undefined"!=typeof t.icon&&e('<span class="widget-icon" />').addClass(t.icon).prependTo(i.find(".widget-type-wrapper")),i.data("class",t["class"]).appendTo(this.$el.find(".widget-type-list"))},this);var s=this.$el.find(".so-sidebar-tabs");t.each(i.widget_dialog_tabs,function(t){e(this.dialogTabTemplate({title:t.title})).data({message:t.message,filter:t.filter}).appendTo(s)},this),this.initTabs();var l=this;e(window).resize(function(){l.balanceWidgetHeights()})},tabClickHandler:function(e){this.filter=e.parent().data("filter"),
this.filter.search=this.$el.find(".so-sidebar-search").val();var i=e.parent().data("message");return t.isEmpty(i)&&(i=""),this.$(".so-toolbar .so-status").html(i),this.filterWidgets(this.filter),!1},searchHandler:function(t){this.filter.search=e(t.target).val(),this.filterWidgets(this.filter)},filterWidgets:function(s){"undefined"==typeof s&&(s={}),"undefined"==typeof s.groups&&(s.groups=""),this.$el.find(".widget-type-list .widget-type").each(function(){var l,o=e(this),n=o.data("class"),a="undefined"!=typeof i.widgets[n]?i.widgets[n]:null;l=0===s.groups.length?!0:null!==a&&t.intersection(s.groups,i.widgets[n].groups).length?!0:!1,l&&"undefined"!=typeof s.search&&""!==s.search&&-1===a.title.toLowerCase().indexOf(s.search.toLowerCase())&&(l=!1),l?o.show():o.hide()}),this.balanceWidgetHeights()},widgetClickHandler:function(t){this.builder.addHistoryEntry("widget_added");var i=e(t.currentTarget),l=new s.model.widget({"class":i.data("class")});l.cell=this.builder.getActiveCell(),l.cell.widgets.add(l),this.closeDialog()},balanceWidgetHeights:function(i){var s=[[]],l=null,o=Math.round(this.$(".widget-type").parent().width()/this.$(".widget-type").width());this.$(".widget-type").css("clear","none").filter(":visible").each(function(t,i){t%o===0&&0!==t&&e(i).css("clear","both")}),this.$(".widget-type-wrapper").css("height","auto").filter(":visible").each(function(t,i){var o=e(i);null!==l&&l.position().top!==o.position().top&&(s[s.length]=[]),l=o,s[s.length-1].push(o)}),t.each(s,function(e,i){var s=t.max(e.map(function(e){return e.height()}));t.each(e,function(e){e.height(s)})})}}),s.dialog.widget=s.view.dialog.extend({builder:null,sidebarWidgetTemplate:t.template(e("#siteorigin-panels-dialog-widget-sidebar-widget").html().panelsProcessTemplate()),dialogClass:"so-panels-dialog-edit-widget",widgetView:!1,events:{"click .so-close":"saveHistory","click .so-nav.so-previous":"navToPrevious","click .so-nav.so-next":"navToNext","click .so-toolbar .so-delete":"deleteHandler","click .so-toolbar .so-duplicate":"duplicateHandler"},initializeDialog:function(){this.model.on("destroy",this.remove,this)},render:function(){this.renderDialog(this.parseDialogContent(e("#siteorigin-panels-dialog-widget").html(),{})),this.loadForm(),this.$(".so-title .widget-name").html("undefined"!=typeof i.widgets[this.model.get("class")]?i.widgets[this.model.get("class")].title:i.loc.missing_widget.title),this.styles=new s.view.styles,this.styles.model=this.model,this.styles.render("widget",e("#post_ID").val(),{builderType:this.builder.builderType}),this.styles.attach(this.$(".so-sidebar.so-right-sidebar")),this.styles.on("styles_loaded",function(){this.$(".so-sidebar.so-right-sidebar").removeClass("so-panels-loading")},this),this.$(".so-sidebar.so-right-sidebar").addClass("so-panels-loading")},getPrevDialog:function(){var e=this.builder.$(".so-cells .cell .so-widget");if(e.length<=1)return!1;var t=e.index(this.widgetView.$el);if(0===t)return!1;var i=e.eq(t-1).data("view");return"undefined"==typeof i?!1:i.getEditDialog()},getNextDialog:function(){var e=this.builder.$(".so-cells .cell .so-widget");if(e.length<=1)return!1;var t=e.index(this.widgetView.$el);if(t===e.length-1)return!1;var i=e.eq(t+1).data("view");return"undefined"==typeof i?!1:i.getEditDialog()},loadForm:function(){var t=this;this.$el.find(".so-content").addClass("so-panels-loading");var s={action:"so_panels_widget_form",widget:this.model.get("class"),instance:JSON.stringify(this.model.get("values")),raw:this.model.get("raw")};e.post(i.ajaxurl,s,function(e){var i=e.replace(/{\$id}/g,t.model.cid);t.$el.find(".so-content").removeClass("so-panels-loading").html(i),t.trigger("form_loaded",t),t.$el.find(".panel-dialog").trigger("panelsopen"),t.on("close_dialog",t.saveWidget,t)},"html")},saveWidget:function(){if(!this.model.get("missing")){var e=this.getFormValues();"undefined"==typeof e.widgets?e={}:(e=e.widgets,e=e[Object.keys(e)[0]]),this.model.setValues(e),this.model.set("raw",!0)}if(this.styles.stylesLoaded){var t={};try{t=this.getFormValues(".so-sidebar .so-visual-styles").style}catch(i){}this.model.set("style",t)}},saveHistory:function(){this.builder.addHistoryEntry("widget_edited"),this.closeDialog()},deleteHandler:function(){return this.builder.liveEditor.displayed?(this.model.destroy(),this.builder.liveEditor.refreshWidgets()):this.model.trigger("visual_destroy"),this.closeDialog(),!1},duplicateHandler:function(){return this.model.trigger("user_duplicate"),this.builder.liveEditor.displayed&&this.builder.liveEditor.refreshWidgets(),this.closeDialog(),!1}}),s.dialog.prebuilt=s.view.dialog.extend({entryTemplate:t.template(e("#siteorigin-panels-dialog-prebuilt-entry").html().panelsProcessTemplate()),directoryTemplate:t.template(e("#siteorigin-panels-directory-items").html().panelsProcessTemplate()),builder:null,dialogClass:"so-panels-dialog-prebuilt-layouts",layoutCache:{},currentTab:!1,directoryPage:1,events:{"click .so-close":"closeDialog","click .so-sidebar-tabs li a":"tabClickHandler","click .so-content .layout":"layoutClickHandler","keyup .so-sidebar-search":"searchHandler","click .so-content .so-directory-item .so-button-use":"directoryClickHandler"},initializeDialog:function(){var e=this;this.on("open_dialog",function(){e.$(".so-sidebar-tabs li a").first().click(),e.$(".so-status").removeClass("so-panels-loading")})},render:function(){this.renderDialog(this.parseDialogContent(e("#siteorigin-panels-dialog-prebuilt").html(),{}))},tabClickHandler:function(t){this.$(".so-sidebar-tabs li").removeClass("tab-active");var s=e(t.target),l=s.attr("href").split("#")[1];s.parent().addClass("tab-active");var o=this;return this.$(".so-content").empty(),o.currentTab=l,"directory"===l?this.displayLayoutDirectory():"import"===l?this.displayImportExport():"undefined"==typeof this.layoutCache[l]?(this.$(".so-content").addClass("so-panels-loading"),e.get(i.ajaxurl,{action:"so_panels_prebuilt_layouts",type:l},function(e){o.layoutCache[l]=e,o.currentTab===l&&(o.$(".so-content").removeClass("so-panels-loading"),o.displayLayouts(l,e))})):o.displayLayouts(l,this.layoutCache[l]),o.$(".so-sidebar-search").val(""),!1},displayLayouts:function(i,s){var l=this.$(".so-content").empty(),o=this.$(".so-sidebar-search").val().toLowerCase();if("undefined"!=typeof s.error_message)return void this.$(".so-content").append(e('<div class="so-error-message">').html(s.error_message));if(t.size(s))for(var n in s)if(s.hasOwnProperty(n)){if("prebuilt"!==i&&n===e("#post_ID").val())continue;if(""!==o&&-1===s[n].name.toLowerCase().indexOf(o))continue;var a=e(this.entryTemplate({name:s[n].name,description:s[n].description}));a.appendTo(l).data({type:i,lid:n})}},layoutClickHandler:function(t){var i=e(t.target).closest(".layout");return this.loadLayout(i.data("type"),i.data("lid")),!1},loadLayout:function(t,s){var l=this;return confirm(i.loc.prebuilt_confirm)?(this.setStatusMessage(i.loc.prebuilt_loading,!0),void e.post(i.ajaxurl,{action:"so_panels_get_prebuilt_layout",type:t,lid:s},function(e){l.setStatusMessage("",!1),l.builder.addHistoryEntry("prebuilt_loaded"),l.builder.model.loadPanelsData(e),l.closeDialog()})):!1},displayImportExport:function(){var t=this.$(".so-content").empty().removeClass("so-panels-loading");t.html(e("#siteorigin-panels-dialog-prebuilt-importexport").html());var s=this,l=s.$(".import-upload-ui").hide(),o=new plupload.Uploader({runtimes:"html5,silverlight,flash,html4",browse_button:l.find(".file-browse-button").get(0),container:l.get(0),drop_element:l.find(".drag-upload-area").get(0),file_data_name:"panels_import_data",multiple_queues:!1,max_file_size:i.plupload.max_file_size,url:i.plupload.url,flash_swf_url:i.plupload.flash_swf_url,silverlight_xap_url:i.plupload.silverlight_xap_url,filters:[{title:i.plupload.filter_title,extensions:"json"}],multipart_params:{action:"so_panels_import_layout"},init:{PostInit:function(e){e.features.dragdrop&&l.addClass("has-drag-drop"),l.show().find(".progress-precent").css("width","0%")},FilesAdded:function(e){l.find(".file-browse-button").blur(),l.find(".drag-upload-area").removeClass("file-dragover"),l.find(".progress-bar").fadeIn("fast"),e.start()},UploadProgress:function(e,t){l.find(".progress-precent").css("width",t.percent+"%")},FileUploaded:function(e,t,l){var o=JSON.parse(l.response);"undefined"!=typeof o.widgets?(s.builder.addHistoryEntry("prebuilt_loaded"),s.builder.model.loadPanelsData(o),s.closeDialog()):alert(i.plupload.error_message)},Error:function(){alert(i.plupload.error_message)}}});o.init(),l.find(".drag-upload-area").on("dragover",function(){e(this).addClass("file-dragover")}).on("dragleave",function(){e(this).removeClass("file-dragover")}),t.find(".so-export").submit(function(t){var i=e(this);i.find('input[name="panels_export_data"]').val(JSON.stringify(s.builder.model.getPanelsData()))})},displayLayoutDirectory:function(s,l){var o=this,n=this.$(".so-content").empty().addClass("so-panels-loading");return void 0===s&&(s=""),void 0===l&&(l=1),i.directory_enabled?void e.get(i.ajaxurl,{action:"so_panels_directory_query",search:s,page:l},function(a){if("directory"===o.currentTab){n.removeClass("so-panels-loading").html(o.directoryTemplate(a));var r=n.find(".so-previous"),d=n.find(".so-next");1>=l?r.addClass("button-disabled"):r.click(function(e){e.preventDefault(),o.displayLayoutDirectory(s,l-1)}),l===a.max_num_pages||0==a.max_num_pages?d.addClass("button-disabled"):d.click(function(e){e.preventDefault(),o.displayLayoutDirectory(s,l+1)}),""!==s&&n.find(".so-directory-browse").html(i.loc.search_results_header+'"<em>'+t.escape(s)+'</em>"'),n.find(".so-screenshot").each(function(){var t=e(this),i=t.find("a");i.css("height",i.width()/4*3+"px").addClass("so-loading");var s=e("<img/>").attr("src",t.data("src")).load(function(){i.removeClass("so-loading").css("height","auto"),s.appendTo(i).hide().fadeIn("fast")})})}},"json"):(n.removeClass("so-panels-loading").html(e("#siteorigin-panels-directory-enable").html()),void n.find(".so-panels-enable-directory").click(function(t){t.preventDefault(),e.get(i.ajaxurl,{action:"so_panels_directory_enable"},function(){}),i.directory_enabled=!0,n.addClass("so-panels-loading"),o.displayLayoutDirectory(s,l)}))},directoryClickHandler:function(t){t.preventDefault();var s=e(t.currentTarget),l=this;return confirm(i.loc.prebuilt_confirm)?(this.setStatusMessage(i.loc.prebuilt_loading,!0),void e.get(i.ajaxurl,{action:"so_panels_directory_item",layout_slug:s.data("layout-slug")},function(e){void 0!==e.error?alert(e.error):(l.setStatusMessage("",!1),l.builder.addHistoryEntry("prebuilt_loaded"),l.builder.model.loadPanelsData(e),l.closeDialog())})):!1},searchHandler:function(t){if("directory"!==this.currentTab){if(this.currentTab===!1||"undefined"==typeof this.layoutCache[this.currentTab])return!1;this.displayLayouts(this.currentTab,this.layoutCache[this.currentTab])}else 13===t.keyCode&&this.displayLayoutDirectory(e(t.currentTarget).val(),1)}}),s.dialog.row=s.view.dialog.extend({cellPreviewTemplate:t.template(e("#siteorigin-panels-dialog-row-cell-preview").html().panelsProcessTemplate()),events:{"click .so-close":"closeDialog","click .so-toolbar .so-save":"saveHandler","click .so-toolbar .so-insert":"insertHandler","click .so-toolbar .so-delete":"deleteHandler","click .so-toolbar .so-duplicate":"duplicateHandler","change .row-set-form > *":"setCellsFromForm","click .row-set-form button.set-row":"setCellsFromForm"},dialogClass:"so-panels-dialog-row-edit",styleType:"row",dialogType:"edit",row:{cells:[],style:{}},initializeDialog:function(){this.on("open_dialog",function(){this.setRowModel("undefined"!=typeof this.model&&0!==this.model.cells.length?this.model:null),this.regenerateRowPreview()},this),this.row={cells:[.5,.5],style:{}}},setRowDialogType:function(e){this.dialogType=e},render:function(t){this.renderDialog(this.parseDialogContent(e("#siteorigin-panels-dialog-row").html(),{dialogType:this.dialogType})),"edit"===this.dialogType&&(this.styles=new s.view.styles,this.styles.model=this.model,this.styles.render("row",e("#post_ID").val(),{builderType:this.builder.builderType}),this.styles.attach(this.$(".so-sidebar.so-right-sidebar")),this.styles.on("styles_loaded",function(){this.$(".so-sidebar.so-right-sidebar").removeClass("so-panels-loading")},this),this.$(".so-sidebar.so-right-sidebar").addClass("so-panels-loading")),"undefined"!=typeof this.model&&this.$("input.so-row-field").val(this.model.cells.length);return this.$("input.so-row-field").keyup(function(){e(this).trigger("change")}),this},setRowModel:function(e){return this.model=e,t.isEmpty(this.model)?this:(this.row={cells:this.model.cells.map(function(e){return e.get("weight")}),style:{}},this.$("input.so-row-field").val(this.model.cells.length),this)},regenerateRowPreview:function(){var i=this,s=this.$(".row-preview");s.empty();var l;t.each(this.row.cells,function(o,n){var a=e(this.cellPreviewTemplate({weight:o}));s.append(a);var r,d=a.prev();0!==d.length&&(r=e('<div class="resize-handle"></div>'),r.appendTo(a).dblclick(function(){var e=i.row.cells[n]+i.row.cells[n-1];i.row.cells[n]=i.row.cells[n-1]=e/2,i.scaleRowWidths()}),r.draggable({axis:"x",containment:s,start:function(t,i){var s=a.clone().appendTo(i.helper).css({position:"absolute",top:"0",width:a.outerWidth(),left:6,height:a.outerHeight()});s.find(".resize-handle").remove();var l=d.clone().appendTo(i.helper).css({position:"absolute",top:"0",width:d.outerWidth(),right:6,height:d.outerHeight()});l.find(".resize-handle").remove(),e(this).data({newCellClone:s,prevCellClone:l}),a.find("> .preview-cell-in").css("visibility","hidden"),d.find("> .preview-cell-in").css("visibility","hidden")},drag:function(t,l){{var o=i.row.cells[n]-(l.position.left+6)/s.width(),a=i.row.cells[n-1]+(l.position.left+6)/s.width();l.helper.offset().left-s.offset().left-6}e(this).data("newCellClone").css("width",s.width()*o).find(".preview-cell-weight").html(Math.round(1e3*o)/10),e(this).data("prevCellClone").css("width",s.width()*a).find(".preview-cell-weight").html(Math.round(1e3*a)/10)},stop:function(t,l){e(this).data("newCellClone").remove(),e(this).data("prevCellClone").remove(),a.find(".preview-cell-in").css("visibility","visible"),d.find(".preview-cell-in").css("visibility","visible");var o=l.position.left+6,r=o/s.width();i.row.cells[n]-r>.02&&i.row.cells[n-1]+r>.02&&(i.row.cells[n]-=r,i.row.cells[n-1]+=r),i.scaleRowWidths(),l.helper.css("left",-6)}})),a.find(".preview-cell-weight").click(function(o){i.$(".resize-handle").css("pointer-event","none").draggable("disable"),s.find(".preview-cell-weight").each(function(){var o=e(this).hide();e('<input type="text" class="preview-cell-weight-input no-user-interacted" />').val(parseFloat(o.html())).insertAfter(o).focus(function(){clearTimeout(l)}).keyup(function(t){9!==t.keyCode&&e(this).removeClass("no-user-interacted"),13===t.keyCode&&(t.preventDefault(),e(this).blur())}).keydown(function(t){if(9===t.keyCode){t.preventDefault();var i=s.find(".preview-cell-weight-input"),l=i.index(e(this));l===i.length-1?i.eq(0).focus().select():i.eq(l+1).focus().select()}}).blur(function(){s.find(".preview-cell-weight-input").each(function(t,s){isNaN(parseFloat(e(s).val()))&&e(s).val(Math.floor(1e3*i.row.cells[t])/10)}),l=setTimeout(function(){if(0===s.find(".preview-cell-weight-input").length)return!1;var l=[],o=[],n=0,a=0;if(s.find(".preview-cell-weight-input").each(function(t,s){var r=parseFloat(e(s).val());r=isNaN(r)?1/i.row.cells.length:Math.round(10*r)/1e3;var d=!e(s).hasClass("no-user-interacted");l.push(r),o.push(d),d?n+=r:a+=r}),n>0&&a>0&&1-n>0)for(var r=0;r<l.length;r++)o[r]||(l[r]=l[r]/a*(1-n));var d=t.reduce(l,function(e,t){return e+t});l=l.map(function(e){return e/d}),Math.min.apply(Math,l)>.01&&(i.row.cells=l),s.find(".preview-cell").each(function(t,s){e(s).animate({width:Math.round(1e3*i.row.cells[t])/10+"%"},250),e(s).find(".preview-cell-weight-input").val(Math.round(1e3*i.row.cells[t])/10)}),s.find(".preview-cell").css("overflow","visible"),setTimeout(function(){i.regenerateRowPreview()},260)},100)}).click(function(){e(this).select()})}),e(this).siblings(".preview-cell-weight-input").select()})},this)},scaleRowWidths:function(){var t=this;this.$(".row-preview .preview-cell").each(function(i,s){e(s).css("width",100*t.row.cells[i]+"%").find(".preview-cell-weight").html(Math.round(1e3*t.row.cells[i])/10)})},setCellsFromForm:function(){var i={cells:parseInt(this.$el.find('.row-set-form input[name="cells"]').val()),ratio:parseFloat(this.$el.find('.row-set-form select[name="ratio"]').val()),direction:this.$el.find('.row-set-form select[name="ratio_direction"]').val()},s=[];if(isNaN(i.cells)||isNaN(i.ratio))return!1;var l=this.row.cells.length!==i.cells;i.cells<1?(this.$el.find('.row-set-form input[name="cells"]').val(1),i.cells=1):i.cells>20&&(this.$el.find('.row-set-form input[name="cells"]').val(20),i.cells=20);for(var o=1,n=0;n<i.cells;n++)s.push(o),o*=i.ratio;var a=t.reduce(s,function(e,t){return e+t});if(s=t.map(s,function(e){return e/a}),s=t.filter(s,function(e){return e>.01}),"left"===i.direction&&(s=s.reverse()),this.row.cells=s,l)this.regenerateRowPreview();else{var r=this;this.$el.find(".preview-cell").each(function(t,i){e(i).animate({width:Math.round(1e3*r.row.cells[t])/10+"%"},250),e(i).find(".preview-cell-weight").html(Math.round(1e3*r.row.cells[t])/10)}),this.$el.find(".preview-cell").css("overflow","visible"),setTimeout(function(){r.regenerateRowPreview()},260)}this.$el.find(".row-set-form .so-button-row-set").removeClass("button-primary")},tabClickHandler:function(e){"#row-layout"===e.attr("href")?this.$(".so-panels-dialog").addClass("so-panels-dialog-has-right-sidebar"):this.$(".so-panels-dialog").removeClass("so-panels-dialog-has-right-sidebar")},updateModel:function(){if(this.model.setCells(this.row.cells),"undefined"!=typeof this.styles&&this.styles.stylesLoaded){var e={};try{e=this.getFormValues(".so-sidebar .so-visual-styles").style}catch(t){}this.model.set("style",e)}},insertHandler:function(){this.builder.addHistoryEntry("row_added"),this.model=new s.model.row,this.updateModel();var e=this.builder.getActiveCell({createCell:!1,defaultPosition:"last"}),t={};return null!==e&&(t.at=this.builder.model.rows.indexOf(e.row)+1),this.model.collection=this.builder.model.rows,this.builder.model.rows.add(this.model,t),this.closeDialog(),!1},saveHandler:function(){return this.builder.addHistoryEntry("row_edited"),this.updateModel(),this.closeDialog(),!1},deleteHandler:function(){return this.model.trigger("visual_destroy"),this.closeDialog(),!1},duplicateHandler:function(){this.builder.addHistoryEntry("row_duplicated");var e=this.model.clone(this.builder.model);return this.builder.model.rows.add(e,{at:this.builder.model.rows.indexOf(this.model)+1}),this.closeDialog(),!1}}),window.siteoriginPanels=s}(jQuery,_,soPanelsOptions),jQuery(function(e){var t=!1,i=!1,s=!1,l=!1,o="";if(e("#siteorigin-panels-metabox").length&&e("form#post").length)t=e("#siteorigin-panels-metabox"),i=e("#siteorigin-panels-metabox .siteorigin-panels-data-field"),s=e("form#post"),l=e("#post_ID").val(),o="editor_attached";else if(e(".siteorigin-panels-builder-form").length){var n=e(".siteorigin-panels-builder-form");t=n.find(".siteorigin-panels-builder"),i=n.find('input[name="panels_data"]'),s=n,l=e("#panels-home-page").data("post-id"),o=n.data("type")}if(t!==!1){var a=window.siteoriginPanels,r=new a.model.builder,d=new a.view.builder({model:r});d.render().attach({container:t,type:o}).setDataField(i).attachToEditor().addLiveEditor(l).addHistoryBrowser(),s.submit(function(e){r.refreshPanelsData()}),t.removeClass("so-panels-loading"),e(document).trigger("panels_setup",d,window.panels)}}),function(e){var t=window.siteoriginPanels;e.fn.soPanelsSetupBuilderWidget=function(){return this.each(function(){var i=e(this),s=i.closest("form").find(".widget-id").val();if(!("undefined"!=typeof s&&s.indexOf("__i__")>-1)){var l=new t.model.builder,o=new t.view.builder({model:l}),n=i.closest(".so-panels-dialog-wrapper").data("view");"undefined"!=typeof n&&(n.on("close_dialog",function(){l.refreshPanelsData()}),n.on("open_dialog_complete",function(){o.trigger("builder_resize")}),n.model.on("destroy",function(){l.emptyRows().destroy()}),o.setDialogParents(soPanelsOptions.loc.layout_widget,n));var a=Boolean(i.closest(".widget-content").length);o.render().attach({container:i,dialog:a,type:i.data("type")}).setDataField(i.find("input.panels-data")),a?(o.setDialogParents(soPanelsOptions.loc.layout_widget,o.dialog),i.find(".siteorigin-panels-display-builder").click(function(){o.dialog.openDialog()})):i.find(".siteorigin-panels-display-builder").parent().remove(),e(document).trigger("panels_setup",o)}})},e(document).on("widget-added",function(t,i){e(i).find(".siteorigin-page-builder-widget").soPanelsSetupBuilderWidget()}),e("body").hasClass("wp-customizer")||e(function(){e(".siteorigin-page-builder-widget").soPanelsSetupBuilderWidget()})}(jQuery);